service: power

frameworkVersion: '2'

provider:
  name: aws
  region: ap-south-1
  runtime: nodejs12.x
  stage: ${opt:stage, 'development'}
  profile: power
  environment:
    DB_HOST: ${env:DB_HOST}
    DB_PASSWORD: ${env:DB_PASSWORD}
    DB_PORT: ${env:DB_PORT, '5432'}
    DB_USER: ${env:DB_USER}
  httpApi:
    payload: '1.0'
  iamRoleStatements:
    - Effect: 'Allow'
      Resource: '*'
      Action:
        - 's3:*'
        - 'cognito-idp:*'
plugins:
  - serverless-dotenv-plugin
  - serverless-prune-plugin
  - serverless-webpack
  - serverless-offline

functions:
  app:
    handler: apps/app/src/handler.default
    events:
      - httpApi:
          method: GET
          path: /graphql
          cors: true
      - httpApi:
          method: POST
          path: /graphql
          cors: true

  cms:
    handler: apps/cms/src/handler.default
    events:
      - httpApi:
          method: GET
          path: /cms
      - httpApi:
          method: POST
          path: /cms

custom:
  serverless-offline:
    allowCache: true
    noPrependStageInUrl: true
  webpack:
    includeModules:
      # Include dynamically imported modules
      forceInclude:
        - 'pg'
        - 'apollo-server-express'
        - '@nestjs/platform-express'
        - 'class-validator'
        - 'class-transformer'
      forceExclude:
        - aws-sdk # available in lambda env by default
    packager: npm
